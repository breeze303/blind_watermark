
<!doctype html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>盲水印工具</title>
    <style>
        /* [Keeping the existing Apple-style CSS] */
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f5f5f7;
            color: #1d1d1f;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .container { max-width: 680px; margin: 40px auto; padding: 40px; background: #ffffff; border-radius: 12px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); }
        h1, h2 { color: #1d1d1f; border-bottom: 1px solid #e5e5e7; padding-bottom: 10px; margin-bottom: 20px; }
        h1 { font-size: 28px; }
        h2 { font-size: 22px; }
        form { margin-bottom: 30px; }
        p { margin: 0 0 15px 0; font-size: 14px; color: #6e6e73; }
        input[type="file"], input[type="text"], input[type="password"], input[type="number"] { width: 100%; padding: 10px 12px; font-size: 16px; border: 1px solid #d2d2d7; border-radius: 8px; box-sizing: border-box; transition: box-shadow 0.2s, border-color 0.2s; }
        input:focus { outline: none; border-color: #007aff; box-shadow: 0 0 0 4px rgba(0, 122, 255, 0.3); }
        input[type="submit"] { width: 100%; padding: 12px 20px; font-size: 16px; font-weight: 600; background-color: #007aff; color: white; border: none; border-radius: 8px; cursor: pointer; transition: background-color 0.2s; }
        input[type="submit"]:hover { background-color: #0056b3; }
        .result { padding: 15px; margin-bottom: 20px; border-radius: 8px; font-size: 15px; }
        .result.embedded { background-color: #e6f7ff; border: 1px solid #91d5ff; color: #0050b3; }
        .result.extracted { background-color: #f6ffed; border: 1px solid #b7eb8f; color: #389e0d; }
        .result.error { background-color: #fff1f0; border: 1px solid #ffa39e; color: #cf1322; }
        .result a { color: #0050b3; font-weight: 600; text-decoration: none; }
        .result a:hover { text-decoration: underline; }
    </style>
</head>
<body>
    <div class="container">
        <h1>盲水印工具</h1>

        {% if error %}
        <div class="result error">
            <p>{{ error }}</p>
        </div>
        {% endif %}

        {% if result == 'embedded' %}
        <div class="result embedded">
            <p><strong>水印嵌入成功！</strong></p>
            <p>水印形状为：<strong>{{ wm_shape }}</strong> (已自动为您填入下方提取表单)</p>
            <p><a href="{{ download_url }}">点击此处下载带水印的图片</a></p>
        </div>
        {% elif result == 'extracted' %}
        <div class="result extracted">
            <p><strong>提取成功！</strong></p>
            {% if wm_is_image %}
                <p>提取出的水印图片：<br><img src="{{ wm_content }}" alt="Extracted Watermark" style="max-width:100%; border:1px solid #ddd; border-radius:4px;"></p>
            {% else %}
                <p>提取出的水印文字为：<strong>{{ wm_content }}</strong></p>
            {% endif %}
        </div>
        {% endif %}

        <h2>嵌入水印</h2>
        <form action="/embed" method="post" enctype="multipart/form-data">
            <p>选择图片<br><input type="file" name="file" required></p>

            <p>选择水印类型<br>
                <input type="radio" name="wm_type" value="text" checked onchange="toggleWmInput()"> 文本水印
                <input type="radio" name="wm_type" value="image" onchange="toggleWmInput()"> 图片水印
            </p>

            <div id="text_wm_div">
                <p>输入水印文字<br><input type="text" name="wm_content" placeholder="例如：版权所有"></p>
            </div>
            <div id="image_wm_div" style="display:none;">
                <p>选择水印图片<br><input type="file" name="wm_file"></p>
            </div>

            <p>输入密码<br><input type="password" name="password" placeholder="请输入您的密码" required></p>
            <p><input type="submit" value="嵌入水印"></p>
        </form>

        <h2>提取水印</h2>
        <form action="/extract" method="post" enctype="multipart/form-data">
            <p>选择带水印的图片<br><input type="file" name="file" required></p>
            <p>输入水印形状<br><input type="text" id="wm_shape_input" name="wm_shape" required placeholder="例如: 111 或 128,128"></p>
            <p>输入密码<br><input type="password" name="password" placeholder="请输入您的密码" required></p>
            <p><input type="submit" value="提取水印"></p>
        </form>
    </div>

    <script>
        function toggleWmInput() {
            const wmType = document.querySelector('input[name="wm_type"]:checked').value;
            const textDiv = document.getElementById('text_wm_div');
            const imageDiv = document.getElementById('image_wm_div');
            const textInput = textDiv.querySelector('input');
            const imageInput = imageDiv.querySelector('input');

            if (wmType === 'text') {
                textDiv.style.display = 'block';
                imageDiv.style.display = 'none';
                textInput.required = true;
                imageInput.required = false;
            } else {
                textDiv.style.display = 'none';
                imageDiv.style.display = 'block';
                textInput.required = false;
                imageInput.required = true;
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            toggleWmInput(); // Set initial state

            {% if wm_shape %}
                const wmShapeInput = document.getElementById('wm_shape_input');
                if (wmShapeInput) {
                    wmShapeInput.value = '{{ wm_shape }}';
                }
            {% endif %}
        });
    </script>

</body>
</html>
